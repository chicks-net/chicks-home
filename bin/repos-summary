#!/usr/bin/env bash

# sorta strict mode
set -u # Catch undefined variables

# Color variables
BLUE='\033[34m'
RED='\033[31m'
CYAN='\033[36m'
RESET='\033[0m'

function carp {
	echo "carp $1"
	exit 2
}

gitdir=~/Documents/git
cd "$gitdir" || carp "failed to chdir; $!"

# Template repo for .just file comparison
template_repo=~/Documents/git/template-repo
template_just_file="$template_repo/.just/gh-process.just"

# Calculate checksum of template .just file if it exists
if [[ -f "$template_just_file" ]]; then
	template_just_checksum=$(md5 -q "$template_just_file" 2>/dev/null || echo "")
else
	template_just_checksum=""
fi

# Array to store repos with modified files
declare -a modified_repos
# Array to store repos with outdated .just files
declare -a outdated_just_repos

for dir in ~/Documents/Creative_Writing/cw $(find "$gitdir" -type d -mindepth 1 -maxdepth 1 -print | sort) $(find ~/LocalDocuments/git -type d -mindepth 1 -maxdepth 1 -print | sort); do
	echo "dir=$dir"

	if [[ -d "$dir/.git" ]]; then
		#echo "  - looks like a git repo"

		branch=$(
			cd "$dir" || exit
			git branch --show-current
		)

		if [[ ! -f "$dir/.github/workflows/claude-code-review.yml" ]]; then
			echo -e "  - ${CYAN}No Claude code review in this repo.${RESET}"
		fi

		# Check .just/gh-process.just version
		if [[ -n "$template_just_checksum" ]]; then
			repo_just_file="$dir/.just/gh-process.just"
			if [[ -f "$repo_just_file" ]]; then
				repo_just_checksum=$(md5 -q "$repo_just_file" 2>/dev/null || echo "")
				if [[ "$repo_just_checksum" != "$template_just_checksum" ]]; then
					echo -e "  - ${BLUE}Outdated .just/gh-process.just (differs from template-repo)${RESET}"
					outdated_just_repos+=("$dir")
				fi
			elif [[ "$dir" != "$template_repo" ]]; then
				# Only report missing if it's not the template repo itself
				echo -e "  - ${CYAN}Missing .just/gh-process.just${RESET}"
				outdated_just_repos+=("missing:$dir")
			fi
		fi

		if [[ "$branch" == "master" ]]; then
			echo -e "  - on branch '$branch' ${BLUE}(deprecated default branch name)${RESET}"
		else
			echo "  - on branch '$branch'"
		fi

		untracked_files=$(
			cd "$dir" || exit
			git status --porcelain | wc -l | sed -e 's/^[ ]*//'
		)
		if [[ "$untracked_files" -gt 0 ]]; then
			echo -e "  - ${RED}$untracked_files untracked or modified files${RESET}"
			modified_repos+=("$untracked_files:$dir")
		fi
	else
		echo "  - not a git repo"
	fi
done

# Print summary of repos with outdated .just files
if [[ ${#outdated_just_repos[@]} -gt 0 ]]; then
	echo
	echo "Summary of repos with outdated or missing .just/gh-process.just:"
	echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
	for repo in "${outdated_just_repos[@]}"; do
		if [[ "$repo" == missing:* ]]; then
			repo_path="${repo#missing:}"
			echo -e "  ${CYAN}MISSING${RESET} in $repo_path"
		else
			echo -e "  ${CYAN}OUTDATED${RESET} in $repo"
		fi
	done
fi

# Print summary of repos with modified files
if [[ ${#modified_repos[@]} -gt 0 ]]; then
	echo
	echo "Summary of repos with modified/untracked files/directories:"
	echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
	printf '%s\n' "${modified_repos[@]}" | sort -nr | while IFS=':' read -r count repo; do
		echo -e "  ${RED}$count${RESET} files in $repo"
	done
fi
