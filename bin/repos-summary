#!/usr/bin/env bash

# sorta strict mode
set -u # Catch undefined variables

# Color variables
BLUE='\033[34m'
RED='\033[31m'
CYAN='\033[36m'
YELLOW='\033[33m'
RESET='\033[0m'

function carp {
	echo "carp $1"
	exit 2
}

gitdir=~/Documents/git
cd "$gitdir" || carp "failed to chdir; $!"

# Template repo for .just file comparison
template_repo=~/Documents/git/template-repo
template_just_file="$template_repo/.just/gh-process.just"

# Calculate checksum of template .just file if it exists
if [[ -f "$template_just_file" ]]; then
	template_just_checksum=$(md5 -q "$template_just_file" 2>/dev/null || echo "")
else
	template_just_checksum=""
fi

# Array to store repos with modified files
declare -a modified_repos
# Array to store repos with outdated .just files
declare -a outdated_just_repos
# Array to store repos with no releases
declare -a no_release_repos
# Array to store repos with stale releases (>60 days)
declare -a stale_release_repos

for dir in ~/Documents/Creative_Writing/cw $(find "$gitdir" -type d -mindepth 1 -maxdepth 1 -print | sort) $(find ~/LocalDocuments/git -type d -mindepth 1 -maxdepth 1 -print | sort); do
	echo "dir=$dir"

	if [[ -d "$dir/.git" ]]; then
		#echo "  - looks like a git repo"

		branch=$(
			cd "$dir" || exit
			git branch --show-current
		)

		if [[ ! -f "$dir/.github/workflows/claude-code-review.yml" ]]; then
			echo -e "  - ${CYAN}No Claude code review in this repo.${RESET}"
		fi

		# Check .just/gh-process.just version
		if [[ -n "$template_just_checksum" ]]; then
			repo_just_file="$dir/.just/gh-process.just"
			if [[ -f "$repo_just_file" ]]; then
				repo_just_checksum=$(md5 -q "$repo_just_file" 2>/dev/null || echo "")
				if [[ "$repo_just_checksum" != "$template_just_checksum" ]]; then
					echo -e "  - ${BLUE}Outdated .just/gh-process.just (differs from template-repo)${RESET}"
					outdated_just_repos+=("$dir")
				fi
			elif [[ "$dir" != "$template_repo" && -d "$dir/.just" ]]; then
				# Only report missing if it's not the template repo itself
				echo -e "  - ${CYAN}Missing .just/gh-process.just${RESET}"
				outdated_just_repos+=("missing:$dir")
			fi
		fi

		if [[ "$branch" == "master" ]]; then
			echo -e "  - on branch '$branch' ${BLUE}(deprecated default branch name)${RESET}"
		else
			echo "  - on branch '$branch'"
		fi

		untracked_files=$(
			cd "$dir" || exit
			git status --porcelain | wc -l | sed -e 's/^[ ]*//'
		)
		if [[ "$untracked_files" -gt 0 ]]; then
			echo -e "  - ${RED}$untracked_files untracked or modified files${RESET}"

			# Check if repo is private
			is_private=$(
				cd "$dir" || exit
				gh repo view --json isPrivate -q .isPrivate 2>/dev/null || echo "unknown"
			)

			if [[ "$is_private" == "true" ]]; then
				modified_repos+=("$untracked_files:private:$dir")
			else
				modified_repos+=("$untracked_files:public:$dir")
			fi
		fi

		# Check for releases
		latest_release=$(
			cd "$dir" || exit
			gh release list --limit 1 2>/dev/null | head -1
		)

		if [[ -z "$latest_release" ]]; then
			echo -e "  - ${YELLOW}No releases found${RESET}"
			no_release_repos+=("$dir")
		else
			# Parse release date (format: tag	title	type	date)
			release_date=$(echo "$latest_release" | awk '{print $4}')
			release_tag=$(echo "$latest_release" | awk '{print $1}')

			if [[ -n "$release_date" ]]; then
				# Convert release date to epoch seconds
				# Extract just the date portion (YYYY-MM-DD) in case there's a timestamp
				clean_date="${release_date:0:10}"
				if release_epoch=$(date -j -f "%Y-%m-%d" "$clean_date" "+%s" 2>/dev/null); then
					current_epoch=$(date "+%s")
					days_old=$(( (current_epoch - release_epoch) / 86400 ))

					# Count commits since last release on main/master branch
					commits_since=$(
						cd "$dir" || exit
						# Determine main branch (main or master)
						if git rev-parse --verify main >/dev/null 2>&1; then
							main_branch="main"
						elif git rev-parse --verify master >/dev/null 2>&1; then
							main_branch="master"
						else
							main_branch=""
						fi

						if [[ -n "$main_branch" && -n "$release_tag" ]]; then
							git rev-list --count "${release_tag}..${main_branch}" 2>/dev/null || echo "0"
						else
							echo "0"
						fi
					)

					# Always show the age of the latest release
					if [[ $days_old -gt 60 ]]; then
						echo -e "  - ${YELLOW}Latest release ($release_tag) is $days_old days old, $commits_since commits since${RESET}"
						stale_release_repos+=("$days_old:$release_tag:$dir")
					else
						echo -e "  - Latest release ($release_tag) is $days_old days old, $commits_since commits since"
					fi
				fi
			fi
		fi
	else
		echo "  - not a git repo"
	fi
done

# Print summary of repos with no releases
if [[ ${#no_release_repos[@]} -gt 0 ]]; then
	echo
	echo "Summary of repos with no releases:"
	echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
	for repo in "${no_release_repos[@]}"; do
		echo -e "  ${YELLOW}NO RELEASES${RESET} in $repo"
	done
fi

# Print summary of repos with stale releases
if [[ ${#stale_release_repos[@]} -gt 0 ]]; then
	echo
	echo "Summary of repos with releases older than 60 days:"
	echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
	printf '%s\n' "${stale_release_repos[@]}" | sort -nr | while IFS=':' read -r days tag repo; do
		echo -e "  ${YELLOW}$days days${RESET} old ($tag) in $repo"
	done
fi

# Print summary of repos with outdated .just files
if [[ ${#outdated_just_repos[@]} -gt 0 ]]; then
	echo
	echo "Summary of repos with outdated or missing .just/gh-process.just:"
	echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
	for repo in "${outdated_just_repos[@]}"; do
		if [[ "$repo" == missing:* ]]; then
			repo_path="${repo#missing:}"
			echo -e "  ${CYAN}MISSING${RESET} in $repo_path"
		else
			echo -e "  ${CYAN}OUTDATED or DIFFERENT${RESET} in $repo"
		fi
	done
fi

# Print summary of repos with modified files
if [[ ${#modified_repos[@]} -gt 0 ]]; then
	echo
	echo "Summary of repos with modified/untracked files/directories:"
	echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
	printf '%s\n' "${modified_repos[@]}" | sort -nr | while IFS=':' read -r count marker repo; do
		# Consistent 3-field format: count:marker:repo
		# marker is either "private" or "public"
		if [[ "$marker" == "private" ]]; then
			echo -e "  ${RED}$count${RESET} files in ${BLUE}[PRIVATE]${RESET} $repo"
		else
			# public repos don't need a marker
			echo -e "  ${RED}$count${RESET} files in $repo"
		fi
	done
fi
